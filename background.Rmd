---
title: "Kerr Mess Around"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(sf)
library(readxl)
```

## Background

This script explores Kerr Reservoir profile data and some upstream ambient trend site data. Scott gets repeated requests for data from DGIF for striper population inquiries and this tool may be expanded to statewide applicability in the future.

## Data Pull (outside R)

The below dataset was pulled outside of R (using Logi Lakes Field Data pull with BRRO 2010-Sept 2019 specified) because DEQ does not allow CEDS connection.

Because Logi query only goes to .xls and has a lot of front matter, I saved original data pull in data/original and deleted front matter and saved each sheet in data/

```{r data in BRRO}
BRRO1 <- read_csv('data/BRRO2010_Sept2019_1.csv')
BRRO2 <- read_csv('data/BRRO2010_Sept2019_2.csv')

# Combine to one dataset
BRRO <- bind_rows(BRRO1,BRRO2) %>%
  filter_all(any_vars(!is.na(.)))  # clean up empty rows

# clean up workspace
rm(BRRO1);rm(BRRO2)

# What stations available?
unique(BRRO$ID)
```


So no Kerr available with BRRO data pull. Rinse and repeat with PRO.

```{r data in PRO}
PRO <- read_csv('data/PRO2010_Sept2019.csv') %>%
  filter_all(any_vars(!is.na(.)))  # clean up empty rows

# What stations available?
unique(PRO$ID)
```

Limit to just Kerr Stations. kerrSites are from Paula's 2020 Stations table.

```{r filter PRO}
kerrSites <- c('4ABHB004.40', '4ABMA002.00', '4ABST001.13', '4ADAN000.00', '4AROA018.36', '4AROA022.52', '4AROA028.04', '4AROA032.42', '4AROA038.49', '4AROA043.14')


kerr <- filter(PRO, ID %in% kerrSites) %>%
  bind_rows(filter(BRRO, ID %in% kerrSites))

```


The data pull isn't perfect because these sites still need to be pulled:
```{r missing}
# Sites that still need to be pulled
kerrSites[!(kerrSites %in% unique(kerr$ID))]
```

Get one profile to play with 4AROA022.52

```{r one profile}
kerr1 <- filter(kerr, ID == '4AROA022.52')

kerr1DO <- select(kerr1, ID, `Date Time`, Depth, `Do Probe`)

```

Build a filled contour plot for the profile.

```{r filled contour}

data <- as.data.frame(kerr1DO)
parameter <- 'Do Probe'
depth <- 'Depth'
date <- 'Date Time'

data = data[!is.na(data[, parameter]) & !is.na(data[, depth]), ]
data[, date] = as.Date(data[, date], format = "%m/%d/%Y %l:%M %p")
int = akima::interp(data[, date], data[, depth], data[, parameter], duplicate = "strip", linear = TRUE)
min_date = min(data[, date], na.rm = T)
max_date = max(data[, date], na.rm = T)
depth_units = "m"

param_lab = "DO"
param_units = 'mg/L'
title = paste0(param_lab, " (", param_units, ")")

criteria=4 # applicable WQS
if (missing(criteria)) {
    criteria = c(0, 10, 15, 20, 25, 30)
  }

filled.contour(int, color.palette = function(n) topo.colors(n, rev=T), 
               xlim = c(min_date - 1, max_date + 1), ylim = rev(range(data[, depth])), 
               ylab = paste0("Depth (", depth_units, ")"), 
               main = title, 
               plot.axes = {
                 contour(int, levels = criteria, lwd = 2, col = "red", 
                         drawlabels = TRUE, axes = FALSE, frame.plot = FALSE, 
                         add = TRUE, labcex = 2)
                 axis(1, at = unique(data[, date]), labels = unique(data[,date]), par(las = 2))
                 axis(2)}
               )
```

Cool, now let's try to beef this function up with some date options and shiny slider capabilities.

```{r functionalize}

data <- as.data.frame(kerr1DO)
parameter <- 'Do Probe'
depth <- 'Depth'
date <- 'Date Time'

data = data[!is.na(data[, parameter]) & !is.na(data[, depth]), ]
data[, date] = as.Date(data[, date], format = "%m/%d/%Y %l:%M %p")
int = akima::interp(data[, date], data[, depth], data[, parameter], duplicate = "strip", linear = TRUE)
min_date = min(data[, date], na.rm = T)
max_date = max(data[, date], na.rm = T)
depth_units = "m"

param_lab = "DO"
param_units = 'mg/L'
title = paste0(param_lab, " (", param_units, ")")

criteria=4 # applicable WQS
if (missing(criteria)) {
    criteria = c(0, 10, 15, 20, 25, 30)
  }

data = kerr1
dateCol <- 'Date Time'
dateTimeFormat <- "%m/%d/%Y %l:%M %p"
depthCol <- 'Depth'
parameterCol = 'Do Probe'
depth_units = "m"
reverseColorPalette = TRUE


interpolateData <- function(data = data,
                            dateCol = NA,
                            dateTimeFormat = '%M-%D-%Y',
                            depthCol= NA,
                            parameterCol = NA,
                            depth_units = NA){
  data <- as.data.frame(data) # only work with dataframes, tibbles etc. are difficult for interpolation method
  
  # manipulate dataset to standardized format
  data1 <- mutate(data, Date = as.Date(get(dateCol), format = dateTimeFormat),
           Depth = get(depthCol),
           parameter = get(parameterCol) ) %>%
    dplyr::select(Date, Depth, parameter) %>% # just the columns we want
    drop_na() # get rid of any missing data bc everything at this point is critical for interpolation
  
  # interpolate between sample events
  int = akima::interp(data1[, 'Date'], data1[, 'Depth'], data1[, 'parameter'], duplicate = "strip", linear = TRUE)
  
  # establish plotting date min/max 
  #min_date <- min(data1[, 'Date'], na.rm = T)
  #max_date <- max(data1[, 'Date'], na.rm = T)
  
  
  results <- list(data1,int)
  return(results)

}  
  

contour.heatmap <- function(int = int,
                            reverseColorPalette = FALSE,
                            title = NA,
                            criteria = NA,
                            depth_units = "m"){
  filled.contour(int[[2]], color.palette = function(n) topo.colors(n, rev= reverseColorPalette), 
               xlim = c(min(int[[1]][, 'Date']) - 1, max(int[[1]][, 'Date']) + 1), 
               ylim = rev(range(int[[1]][, 'Depth'])), 
               ylab = paste0("Depth (", depth_units, ")"), 
               main = title, 
               plot.axes = {
                 contour(int[[2]], levels = criteria, lwd = 2, col = "red", 
                         drawlabels = TRUE, axes = FALSE, frame.plot = FALSE, 
                         add = TRUE, labcex = 2)
                 axis(1, at = unique(int[[1]][, 'Date']), labels = unique(int[[1]][,'Date']), par(las = 2))
                 axis(2)}
               )
  
}

int <- interpolateData(data = kerr1, # to adjust date range you need to limit input data
                       dateCol = 'Date Time',
                       dateTimeFormat = "%m/%d/%Y %l:%M %p",
                       depthCol = 'Depth',
                       parameterCol = 'Do Probe',
                       depth_units = "m")


int_short <- interpolateData(data = kerr1[1:118,], # to adjust date range you need to limit input data
                       dateCol = 'Date Time',
                       dateTimeFormat = "%m/%d/%Y %l:%M %p",
                       depthCol = 'Depth',
                       parameterCol = 'Do Probe',
                       depth_units = "m")

contour.heatmap(int, reverseColorPalette = TRUE, criteria = 4)
contour.heatmap(int_short, reverseColorPalette = TRUE, criteria = 4)


```



So now let's try to scrape data straight from WQX to put into our plotting function.



